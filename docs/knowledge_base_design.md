# 知识库设计文档

## 1. 概述

知识库是本系统的核心功能模块，基于RAG（检索增强生成）技术，支持文档管理、智能问答、权限控制等功能。本文档详细描述知识库的设计方案，包括页面设计、数据库设计、功能设计、权限设计和页面风格设计等方面。

## 2. 页面详细设计

### 2.1 知识库管理页面 (KnowledgeLibrary.vue)

#### 2.1.1 布局结构

知识库管理页面采用响应式布局，主要分为以下几个部分：

1. **页面标题栏**：
   - 标题："知识库管理"
   - 副标题：简短描述
   - 创建知识库按钮

2. **搜索和过滤栏**：
   - 搜索框：按名称和描述搜索
   - 状态筛选：全部/活跃/维护中/已禁用
   - 类型筛选：技术文档/产品手册/培训资料等
   - 排序选项：更新时间/创建时间/名称/文档数量
   - 视图切换：网格视图/列表视图

3. **知识库展示区**：
   - 网格视图：卡片形式展示知识库
   - 列表视图：表格形式展示知识库

4. **操作对话框**：
   - 创建知识库对话框
   - 编辑知识库对话框
   - 删除确认对话框

#### 2.1.2 交互设计

1. **知识库卡片**：
   - 点击卡片：进入知识库详情页
   - 悬停效果：轻微上浮，增加阴影
   - 右上角菜单：编辑/复制/导出/删除

2. **创建知识库流程**：
   - 点击"创建知识库"按钮
   - 填写表单：名称、描述、类型、颜色、是否公开
   - 表单验证：名称必填，至少2个字符
   - 提交表单：创建知识库并刷新列表

3. **搜索和筛选**：
   - 实时搜索：输入即搜索
   - 组合筛选：状态和类型可组合
   - 排序切换：点击排序选项即时生效

### 2.2 知识库详情页面

#### 2.2.1 布局结构

1. **页面头部**：
   - 知识库名称和描述
   - 状态标签和类型标签
   - 操作按钮：编辑/分享/导出/删除

2. **统计信息区**：
   - 文档总数
   - 块总数
   - 最后更新时间
   - 存储空间使用量

3. **标签页导航**：
   - 文档管理：上传和管理文档
   - 设置：知识库参数配置
   - 分享：权限和共享管理
   - 活动日志：操作记录

4. **文档列表区**：
   - 文档表格：名称/类型/大小/状态/上传时间
   - 上传按钮：支持拖放上传
   - 批量操作：选择多个文档进行操作

#### 2.2.2 交互设计

1. **文档上传流程**：
   - 点击上传按钮或拖放文件
   - 文件类型验证
   - 上传进度显示
   - 处理状态实时更新

2. **文档预览**：
   - 点击文档名称：打开预览面板
   - 支持PDF/文本在线预览
   - 显示文档元数据和块信息

3. **知识库设置**：
   - 分块参数设置：块大小、重叠大小
   - 索引设置：向量模型选择
   - 权限设置：访问控制和共享

### 2.3 文档管理页面 (DocumentManagement.vue)

#### 2.3.1 布局结构

1. **文档筛选区**：
   - 按类型筛选
   - 按状态筛选
   - 按上传时间筛选
   - 文档搜索框

2. **文档列表**：
   - 文档卡片或表格视图
   - 文档状态标识
   - 处理进度条
   - 操作按钮

3. **文档详情面板**：
   - 文档预览
   - 元数据信息
   - 块列表
   - 处理日志

#### 2.3.2 交互设计

1. **文档处理流程可视化**：
   - 上传 → 文本提取 → 分块 → 向量化 → 完成
   - 各阶段状态清晰展示
   - 失败原因详细说明

2. **块管理**：
   - 查看文档分块结果
   - 手动调整块内容（高级功能）
   - 重新处理特定块

## 3. 数据库设计

### 3.1 关系型数据库（MySQL）

#### 3.1.1 知识库表 (knowledge_bases)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| name | VARCHAR(255) | 知识库名称，非空 |
| description | TEXT | 知识库描述 |
| type | VARCHAR(50) | 知识库类型 |
| status | ENUM | 状态：'active', 'maintenance', 'disabled' |
| color | VARCHAR(7) | 颜色，Hex格式，默认"#1976D2" |
| is_public | BOOLEAN | 是否公开，默认false |
| created_by | INT | 创建者ID，外键关联users表 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### 3.1.2 文档表 (documents)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| kb_id | INT | 知识库ID，外键关联knowledge_bases表 |
| title | VARCHAR(255) | 文档标题，非空 |
| file_path | VARCHAR(500) | 文件路径，非空 |
| file_type | VARCHAR(50) | 文件类型，非空 |
| file_size | INT | 文件大小（字节） |
| status | ENUM | 状态：'processing', 'completed', 'failed' |
| metadata | JSON | 文档元数据 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### 3.1.3 文档块表 (document_chunks)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| doc_id | INT | 文档ID，外键关联documents表 |
| content | TEXT | 块内容，非空 |
| chunk_index | INT | 块索引，非空 |
| embedding_id | VARCHAR(255) | 向量数据库中的ID，非空 |
| metadata | JSON | 块元数据 |
| created_at | TIMESTAMP | 创建时间 |

### 3.2 向量数据库（ChromaDB）

#### 3.2.1 文档块向量集合 (document_chunks)

```python
{
    "id": "chunk_123",  # 唯一标识符
    "content": "文档块内容",  # 原始文本内容
    "metadata": {  # 元数据
        "doc_id": 123,  # 关联的文档ID
        "kb_id": 1,  # 关联的知识库ID
        "chunk_index": 0,  # 块索引
        "file_type": "pdf",  # 文件类型
        "created_at": "2024-01-20T10:00:00Z"  # 创建时间
    },
    "embedding": [0.1, 0.2, ...]  # 768维向量
}
```

## 4. 功能设计

### 4.1 知识库管理功能

#### 4.1.1 知识库CRUD操作

1. **创建知识库**：
   - 基本信息设置：名称、描述、类型、颜色
   - 高级设置：是否公开、分块参数、向量模型

2. **查看知识库**：
   - 知识库列表：支持搜索、筛选、排序
   - 知识库详情：统计信息、文档列表、设置

3. **更新知识库**：
   - 基本信息更新
   - 状态切换：活跃/维护中/已禁用
   - 设置修改：分块参数、索引设置

4. **删除知识库**：
   - 删除确认
   - 级联删除：文档、块、向量数据

#### 4.1.2 文档管理功能

1. **文档上传**：
   - 单文件上传
   - 批量上传
   - 拖放上传
   - 支持格式：PDF、DOCX、TXT、MD等

2. **文档处理**：
   - 文本提取：根据文件类型选择合适的提取器
   - 智能分块：基于语义边界进行分块
   - 向量化：生成文本嵌入向量
   - 存储：关系型数据库 + 向量数据库

3. **文档操作**：
   - 预览：在线查看文档内容
   - 重新处理：重新执行处理流程
   - 删除：从知识库中移除文档

### 4.2 RAG检索功能

#### 4.2.1 检索策略

1. **多路召回**：
   - 向量检索：基于语义相似度
   - 关键词检索：基于BM25算法
   - 混合检索：融合排序结果

2. **重排序机制**：
   - 相关性评分
   - 时效性权重
   - 用户反馈调整

3. **上下文压缩**：
   - 基于查询的相关性过滤
   - 冗余信息去除
   - 关键信息保留

#### 4.2.2 问答生成

1. **提示词工程**：
   - 系统提示词模板
   - 上下文增强
   - 查询重写

2. **流式响应**：
   - Server-Sent Events (SSE)
   - 分块传输
   - 实时显示

### 4.3 高级功能

1. **知识库导入导出**：
   - 导出格式：JSON、CSV
   - 完整导出：包含文档和块
   - 导入功能：恢复知识库

2. **知识库复制**：
   - 完整复制：包含所有文档和设置
   - 选择性复制：仅复制部分文档

3. **知识库备份**：
   - 手动备份
   - 自动定时备份
   - 备份恢复

4. **知识库统计分析**：
   - 使用情况统计
   - 查询热点分析
   - 性能监控

## 5. 知识库权限设计

### 5.1 权限模型

采用基于角色的访问控制（RBAC）模型，结合知识库级别的权限控制：

1. **系统角色**：
   - 管理员：完全控制权限
   - 内容管理员：知识库管理权限
   - 普通用户：使用权限

2. **知识库权限级别**：
   - 所有者：完全控制权限
   - 管理者：可编辑和管理
   - 编辑者：可上传和修改文档
   - 查看者：只读权限

### 5.2 权限控制实现

1. **知识库访问控制**：
   - 私有知识库：仅创建者和被授权用户可访问
   - 公开知识库：所有用户可查看
   - 组织知识库：特定组织内用户可访问

2. **文档级权限**：
   - 继承知识库权限
   - 特定文档额外权限设置

3. **操作权限矩阵**：

| 操作 | 所有者 | 管理者 | 编辑者 | 查看者 |
|------|--------|--------|--------|--------|
| 查看知识库 | ✓ | ✓ | ✓ | ✓ |
| 编辑知识库信息 | ✓ | ✓ | ✗ | ✗ |
| 上传文档 | ✓ | ✓ | ✓ | ✗ |
| 删除文档 | ✓ | ✓ | ✗ | ✗ |
| 分享知识库 | ✓ | ✓ | ✗ | ✗ |
| 删除知识库 | ✓ | ✗ | ✗ | ✗ |

### 5.3 分享机制

1. **用户分享**：
   - 按用户分配权限
   - 邮件邀请
   - 权限变更通知

2. **链接分享**：
   - 生成访问链接
   - 链接有效期设置
   - 访问权限控制

3. **公开设置**：
   - 知识库公开开关
   - 公开范围限制
   - 公开内容控制

## 6. 页面风格设计

### 6.1 整体风格

1. **设计语言**：
   - 遵循Material Design设计原则
   - 简洁现代的界面风格
   - 响应式设计，适配不同设备

2. **色彩方案**：
   - 主色调：#1976D2（蓝色）
   - 辅助色：绿色、橙色、紫色等
   - 状态颜色：成功（绿）、警告（黄）、错误（红）

3. **排版规范**：
   - 标题：16-24px，加粗
   - 正文：14px
   - 辅助文字：12px，浅灰色

### 6.2 组件设计

1. **知识库卡片**：
   - 顶部彩色区域：显示图标和颜色
   - 中部内容区：名称、描述、状态
   - 底部信息区：创建者、更新时间

2. **文档卡片**：
   - 左侧图标：根据文件类型显示不同图标
   - 右侧内容：文件名、大小、上传时间
   - 状态指示：处理状态和进度

3. **操作按钮**：
   - 主要操作：填充按钮
   - 次要操作：轮廓按钮
   - 危险操作：红色警示

### 6.3 交互反馈

1. **加载状态**：
   - 骨架屏：数据加载中
   - 进度条：上传和处理进度
   - 加载动画：操作执行中

2. **操作反馈**：
   - 成功提示：操作完成通知
   - 错误提示：详细错误信息
   - 确认对话框：重要操作确认

3. **空状态处理**：
   - 空知识库提示：引导创建
   - 空文档列表：引导上传
   - 搜索无结果：提供建议

## 7. 技术实现方案

### 7.1 前端实现

1. **技术栈**：
   - Vue 3 + TypeScript
   - Element Plus 组件库
   - Pinia 状态管理
   - Vue Router 路由管理

2. **代码组织**：
   - 按功能模块组织目录结构
   - 组件化开发，提高复用性
   - 类型定义规范，提高代码质量

3. **API交互**：
   - 封装API请求模块
   - 统一错误处理
   - 请求缓存策略

### 7.2 后端实现

1. **技术栈**：
   - FastAPI框架
   - SQLAlchemy ORM
   - ChromaDB向量数据库
   - LangChain工具链

2. **服务划分**：
   - 知识库管理服务
   - 文档处理服务
   - RAG检索服务
   - 权限控制服务

3. **性能优化**：
   - 异步处理文档
   - 缓存机制
   - 分页查询
   - 向量索引优化

## 8. 部署和扩展性考虑

### 8.1 部署方案

1. **容器化部署**：
   - Docker容器封装
   - Docker Compose编排
   - 环境变量配置

2. **服务扩展**：
   - 水平扩展API服务
   - 向量数据库集群
   - 负载均衡

### 8.2 扩展性设计

1. **模块化架构**：
   - 松耦合设计
   - 插件化扩展
   - 配置驱动

2. **未来扩展点**：
   - 多模型支持
   - 多语言支持
   - 高级分析功能
   - 自定义分块策略

## 9. 测试和质量保证

### 9.1 测试策略

1. **单元测试**：
   - 核心功能单元测试
   - 边界条件测试
   - 异常处理测试

2. **集成测试**：
   - API集成测试
   - 数据流测试
   - 向量检索质量测试

3. **性能测试**：
   - 大文件处理测试
   - 并发查询测试
   - 负载测试

### 9.2 质量指标

1. **性能指标**：
   - 文档处理速度：每分钟处理页数
   - 查询响应时间：平均<500ms
   - 系统并发能力：支持100用户同时使用

2. **准确性指标**：
   - 检索相关性评分
   - 问答准确率
   - 文本提取质量

## 10. 结论

本设计文档详细描述了知识库系统的设计方案，包括页面设计、数据库设计、功能设计、权限设计和页面风格设计等方面。通过实现这些设计，可以构建一个功能完善、用户友好、性能优异的知识库管理系统，为用户提供高效的知识管理和智能问答服务。

后续开发将按照本文档的规划进行实施，同时保持灵活性，根据实际需求和反馈进行调整和优化。
